# About

This module provision a dhcp server on kvm. Optionally, the server can also double up as a pxe server to setup physical hosts on a network.

For the pxe scenario, the server will also install an nginx server to serve files and can optionally synchronize with an etcd cluster and/or an s3 object store.

For pxe, the server serves the ipxe boot firmware: https://ipxe.org/

From there, you can implement your boot logic as a ipxe script, using a http server provisioned inside the dhcp server to serve resources.

# Usage

## Variables

This module takes the following variables as input:

- **name**: Name to give to the vm. Will be used both as hostname and member name in the etcd cluster.
- **vcpus**: Number of vcpus to assign to the vm. Defaults to 2.
- **memory**: Amount of memory in MiB to assign to the vm. Defaults to 8192.
- **volume_id**: Id of the image volume to attach to the vm. A recent version of ubuntu is recommended as this is what this module has been validated against.
- **data_volume_id**: Id for an optional separate disk volume to attach to the vm on etcd's data path
- **libvirt_network**: Parameters to connect to libvirt networks. Note that etcd will only bind on and listen on the first interface (be it macvtap or libvirt network) on its list. It is an array of objects, each having the following keys:
  - **network_id**: Id (ie, uuid) of the libvirt network to connect to (in which case **network_name** should be an empty string).
  - **network_name**: Name of the libvirt network to connect to (in which case **network_id** should be an empty string).
  - **ip**: Ip of interface connecting to the libvirt network.
  - **mac**: Mac address of interface connecting to the libvirt network.
  - **prefix_length**:  Length of the network prefix for the network the interface will be connected to. For a **192.168.1.0/24** for example, this would be **24**.
  - **gateway**: Ip of the network's gateway. Usually the gateway the first assignable address of a libvirt's network.
  - **dns_servers**: Dns servers to use. Usually the dns server is first assignable address of a libvirt's network.
- **macvtap_interfaces**: List of macvtap interfaces to connect the vm to. Note that etcd will only bind on and listen on the first interface (be it macvtap or libvirt network) on its list. Each entry in the list is a map with the following keys:
  - **interface**: Host network interface that you plan to connect your macvtap interface with.
  - **prefix_length**: Length of the network prefix for the network the interface will be connected to. For a **192.168.1.0/24** for example, this would be **24**.
  - **ip**: Ip associated with the macvtap interface. 
  - **mac**: Mac address associated with the macvtap interface
  - **gateway**: Ip of the network's gateway for the network the interface will be connected to.
  - **dns_servers**: Dns servers for the network the interface will be connected to. If there aren't dns servers setup for the network your vm will connect to, the ip of external dns servers accessible from the network will work as well.
- **cloud_init_volume_pool**: Name of the volume pool that will contain the cloud-init volume of the vm.
- **cloud_init_volume_name**: Name of the cloud-init volume that will be generated by the module for your vm. If left empty, it will default to **<name>-cloud-init.iso**.
- **ssh_admin_user**: Username of the default sudo user in the image. Defaults to **ubuntu**.
- **admin_user_password**: Optional password for the default sudo user of the image. Note that this will not enable ssh password connections, but it will allow you to log into the vm from the host using the **virsh console** command.
- **ssh_admin_public_key**: Public part of the ssh key the admin will be able to login as
- **dhcp**: Configurations for the dhcp server. It should have the following keys:
  - **networks**: List of networks to serve. Each entry in the list should have the following keys:
    - **addresses**: Address space of the network (in CIDR notation).
    - **gateway**: Address of the network's gateway
    - **broadcast**: Network's broadcast address
    - **dns_servers**: List of default dns servers that handle dns traffic on the network
    - **range_start**: First ip in the range assignable via the dhcp protocol
    - **range_end**: Last ip in the range assignable via the dhcp protocol
  - **interfaces**: List of interfaces that the server should bind on to server dhcp traffic for various networks.
  - **default_lease_time**: Default lease time to assign to assigned ip addresses if the client doesn't specify it. Should be an integer representing seconds. A value of 0 means that the default of isc dhcp server will be used.
  - **max_lease_time**: Max lease time to assign to assign ip addresses if the client specifies it (a value greater will be reduced to that amount). Should be an integer representing seconds. A value of 0 means that the default of isc dhcp server will be used.
- **pxe**: Optional pxe parameters if you want the dhcp to support remote installation of new servers on the network. It should have the following keys:
  - **enabled**: If true, pxe will be enabled.
  - **self_url**: Self url to return to clients in order to load the ipxe firmware from the server via tftp.
  - **static_boot_script**: Optional static ipxe boot script to use if you do not wish to dynamically manage the content of the http server serving boot files and scripts.
  - **boot_script_path**: Path of the ipxe boot script in the http server's serving directory. This path will be returned by the dhcp server to the ipxe firmware and a boot script should be present at that path if you opt to manage the ipxe boot script dynamically.
- **etcd_sync**: Optional parameters to setup automatic synchronization with an etcd server for the ipxe boot script and other lightweight configuration files.
  - **enabled**: If true, etcd synchronization will be enabled.
  - **url_path**: Path in the http server's serving directory that the etcd keyspace should be synchronized to.
  - **etcd**: Parameters for etcd. It should have the following keys:
      - **key_prefix**: Etcd key prefix to synchronize to. The path of the keys relative to this prefix will be the path of the synchronized files in the http server's directory.
      - **endpoints**: Endpoints (```ip:port``` format) of the etcd cluster.
      - **auth**: Authentication parameters to authentication to the etcd cluster. It should be either certificate or username/password and has the following keys:
        - **ca_certificate**: CA certificate to validate the authenticity of the etcd nodes to connect to.
        - **client_certificate**: Public client certificate to present to the etcd nodes (if certificate authentication is used)
        - **client_key**: Private key to validate ownership of the certificate when authenticating to etcd nodes (if certificate authentication is used)
        - **username**: Username to present to the etcd nodes (if username/password authentication is used)
        - **password**: Password to present to the etcd nodes (if username/password authentication is used)
- **s3_sync**: Optional parameters to setup automatic synchronization with an s3 object store for os images and other larger artifacts.
    - **enabled**: If true, s3 synchronization will be enabled.
    - **url_path**: Path in the http server's serving directory that the objects in the s3 bucket should be synchronized to.
    - **s3**: Parameters for s3. It should have the following keys:
      - **bucket**: Bucket to synchronize with. All the objects in the bucket will be synchronized to the http server's serving directory.
      - **url**: Url of the s3 store.
      - **region**: S3 region where the bucket to use is located.
      - **server_side_encryption**: Server-side encryption scheme of the bucket to synchronize with if any.
      - **auth**: Authentication parameters when connecting to the s3 store. It should have the following keys:
        - **ca_cert**: CA certificate used to authentify the S3 store nodes the client will be connecting to.
        - **access_key**: Access key (ie, username) to provide to the S3 store nodes for authentication.
        - **secret_key**: Secret key (ie, password) to provide to the S3 store nodes for authentication.
- **chrony**: Optional chrony configuration for when you need a more fine-grained ntp setup on your vm. It is an object with the following fields:
  - **enabled**: If set the false (the default), chrony will not be installed and the vm ntp settings will be left to default.
  - **servers**: List of ntp servers to sync from with each entry containing two properties, **url** and **options** (see: https://chrony.tuxfamily.org/doc/4.2/chrony.conf.html#server)
  - **pools**: A list of ntp server pools to sync from with each entry containing two properties, **url** and **options** (see: https://chrony.tuxfamily.org/doc/4.2/chrony.conf.html#pool)
  - **makestep**: An object containing remedial instructions if the clock of the vm is significantly out of sync at startup. It is an object containing two properties, **threshold** and **limit** (see: https://chrony.tuxfamily.org/doc/4.2/chrony.conf.html#makestep)
- **fluentbit**: Optional fluend configuration to securely route logs to a fluend/fluent-bit node using the forward plugin. Alternatively, configuration can be 100% dynamic by specifying the parameters of an etcd store to fetch the configuration from. It has the following keys:
  - **enabled**: If set the false (the default), fluent-bit will not be installed.
  - **dhcp_server_tag**: Tag to assign to logs coming from the dhcp server.
  - **tftp_server_tag**: Tag to assign to logs coming from the tftp server which will serve the ipxe firmware.
  - **http_server_tag**: Tag to assign to logs coming from the http which serves additional artifacts as requested by your ipxe script.
  - **etcd_sync_tag**: Tag to assign to logs coming from the optional etcd synchronizer that will sync scripts and configuration files in your http server's serving directory.
  - **s3_sync_tag**: Tag to assign to logs coming from the optional s3 synchronizer that will sync os images and larger files in your http server's serving directory.
  - **node_exporter_tag** Tag to assign to logs coming from the prometheus node exporter
  - **forward**: Configuration for the forward plugin that will talk to the external fluend/fluent-bit node. It has the following keys:
    - **domain**: Ip or domain name of the remote fluend node.
    - **port**: Port the remote fluend node listens on
    - **hostname**: Unique hostname identifier for the vm
    - **shared_key**: Secret shared key with the remote fluentd node to authentify the client
    - **ca_cert**: CA certificate that signed the remote fluentd node's server certificate (used to authentify it)
  - **etcd**: Parameters to fetch fluent-bit configurations dynamically from an etcd cluster. It has the following keys:
    - **enabled**: If set to true, configurations will be set dynamically. The default configurations can still be referenced as needed by the dynamic configuration. They are at the following paths:
      - **Global Service Configs**: /etc/fluent-bit-customization/default-config/fluent-bit-service.conf
      - **Systemd Inputs**: /etc/fluent-bit-customization/default-config/fluent-bit-inputs.conf
      - **Forward Output**: /etc/fluent-bit-customization/default-config/fluent-bit-output.conf
    - **key_prefix**: Etcd key prefix to search for fluent-bit configuration
    - **endpoints**: Endpoints of the etcd cluster. Endpoints should have the format `<ip>:<port>`
    - **ca_certificate**: CA certificate against which the server certificates of the etcd cluster will be verified for authenticity
    - **client**: Client authentication. It takes the following keys:
      - **certificate**: Client tls certificate to authentify with. To be used for certificate authentication.
      - **key**: Client private tls key to authentify with. To be used for certificate authentication.
      - **username**: Client's username. To be used for username/password authentication.
      - **password**: Client's password. To be used for username/password authentication.
- **install_dependencies**: Whether cloud-init should install external dependencies (should be set to false if you already provide an image with the external dependencies built-in).

## Example

For a local example that supports the installation of ubuntu server in a vm, see: https://github.com/Ferlab-Ste-Justine/kvm-dev-orchestrations/tree/main/dhcp